<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¿Ÿå·å³¶ä¹‹æ—…</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@500;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f1f5f9;
            touch-action: manipulation;
        }

        .bg-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-image: url('https://i.meee.com.tw/9sjqlGA.png');
            background-size: cover;
            background-position: center;
            z-index: -2;
        }

        .bg-dimmer {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(to bottom, rgba(0,0,0,0), rgba(0,0,0,0.5));
            z-index: -1;
        }

        /* æ™‚é–“è»¸ç·šæ¢ */
        .timeline-container {
            position: relative;
        }
        .timeline-line {
            position: absolute;
            left: 28px;
            top: 0;
            bottom: 0;
            width: 3px;
            background: repeating-linear-gradient(to bottom, transparent, transparent 5px, rgba(255,255,255,0.3) 5px, rgba(255,255,255,0.3) 10px);
            z-index: 0;
        }

        .glass-card {
            background: rgba(255, 255, 255, 1);
            border-radius: 20px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.12);
            border: 1px solid #e2e8f0;
            position: relative;
            z-index: 10;
        }

        .cost-card {
            background: #1e293b;
            border: 2px solid #334155;
            box-shadow: 0 10px 25px rgba(0,0,0,0.25);
        }

        .pay-tag {
            font-size: 13px;
            padding: 3px 10px;
            border-radius: 6px;
            font-weight: 700;
        }
        .pay-WOWPASS { background: #fef3c7; color: #92400e; border: 1px solid #fde68a; }
        .pay-tmoney { background: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }
        .pay-card { background: #e0f2fe; color: #075985; border: 1px solid #bae6fd; }
        .pay-cash { background: #f1f5f9; color: #334155; border: 1px solid #e2e8f0; }

        .nav-btn {
            width: 58px;
            height: 58px;
            font-size: 14px;
            font-weight: 900;
            border-radius: 16px;
            transition: all 0.2s ease;
        }

        .plan-btn {
            flex: 1;
            padding: 12px;
            font-weight: 900;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.2s ease;
        }

        /* äº¤é€šé€£çµå¡Š */
        .transport-connector {
            padding: 8px 0 8px 56px;
            position: relative;
            z-index: 5;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade { animation: fadeIn 0.4s ease-out forwards; }
        
        h3 { line-height: 1.3 !important; }
    </style>
</head>
<body class="text-slate-900 pb-16 overflow-x-hidden">

    <div class="bg-overlay"></div>
    <div class="bg-dimmer"></div>

    <!-- æ¨™é¡Œå€ -->
    <section class="relative z-10 pt-12 pb-8 px-6 text-center">
        <h2 class="text-4xl font-black tracking-tight text-white mb-1 drop-shadow-lg">
            6å¤©5å¤œ<br/>
            <span class="text-orange-400">æ¿Ÿå·å³¶ä¹‹æ—…</span>
        </h2>
    </section>

    <!-- å¤©æ•¸å°èˆª -->
    <div class="relative z-40 mb-6">
        <nav id="day-nav" class="flex flex-wrap justify-center gap-2.5 px-4 max-w-lg mx-auto">
            <!-- jQuery æ¸²æŸ“æŒ‰éˆ• -->
        </nav>
    </div>

    <!-- æ–¹æ¡ˆåˆ‡æ›å€ -->
    <div id="plan-switcher" class="relative z-30 max-w-md mx-auto px-4 mb-6 hidden">
        <div class="bg-white/90 p-1.5 rounded-2xl flex gap-2 border border-white shadow-lg">
            <button id="btn-plan-A" class="plan-btn">æ–¹æ¡ˆ A</button>
            <button id="btn-plan-B" class="plan-btn">æ–¹æ¡ˆ B</button>
        </div>
    </div>

    <!-- è¡Œç¨‹å…§å®¹ (å«æ™‚é–“è»¸) -->
    <main class="relative z-10 max-w-md mx-auto px-4">
        <div class="timeline-container">
            <div id="timeline-line" class="timeline-line"></div>
            <div id="schedule-container" class="space-y-0">
                <!-- jQuery æ¸²æŸ“è¡Œç¨‹ -->
            </div>
        </div>
    </main>

    <!-- ä»Šæ—¥çµç®— -->
    <section id="daily-summary" class="max-w-md mx-auto px-4 mt-10 mb-10 relative z-20">
        <div class="cost-card rounded-[28px] p-7">
            <div class="flex items-center justify-between mb-5">
                <div class="flex items-center gap-2.5">
                    <div class="w-9 h-9 bg-orange-500 rounded-lg flex items-center justify-center text-white shadow-lg font-black text-lg">ï¼„</div>
                    <h3 class="text-white font-black text-xl">ä»Šæ—¥èŠ±è²»çµç®—</h3>
                </div>
                <span id="current-day-label" class="text-orange-400 text-sm font-black border border-orange-400/50 px-3 py-0.5 rounded-full uppercase tracking-tighter">Day 1</span>
            </div>
            
            <div class="space-y-4 pb-5 border-b border-white/10">
                <div class="flex justify-between items-end">
                    <p class="text-slate-400 text-xs font-bold mb-1">éŸ“å¹£ç¸½è¨ˆ (KRW)</p>
                    <p id="total-krw" class="text-3xl font-black text-white tabular-nums leading-none">â‚©0</p>
                </div>
                <div class="flex justify-between items-end">
                    <p class="text-slate-400 text-xs font-bold mb-1">å°å¹£ä¼°è¨ˆ (TWD)</p>
                    <p id="total-twd" class="text-3xl font-black text-orange-400 tabular-nums leading-none">NT$ 0</p>
                </div>
            </div>

            <div id="payment-subtotal" class="mt-5 space-y-3">
                <!-- å‹•æ…‹é¡¯ç¤ºæ”¯ä»˜æ–¹å¼ -->
            </div>
            
            <div class="mt-6 text-center border-t border-white/5 pt-4">
                <p id="exchange-rate-info" class="text-[11px] text-slate-500 font-bold leading-relaxed">
                </p>
            </div>
        </div>
    </section>
    <div id="linksModal"
        class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50"
        onclick="closeLinksModal()">
        <div class="bg-white rounded-xl w-80 max-w-[90%] p-4"
            onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-3">
                <h3 class="font-black text-lg">ç›¸é—œé€£çµ</h3>
                <button onclick="closeLinksModal()">âœ•</button>
            </div>
            <div id="linksModalContent" class="space-y-2"></div>
        </div>
    </div>
    <script>
        $(document).ready(function() {
            let currentDay = 1;
            let currentPlan = 'A';
            const exchangeRate = 45;
            $("#exchange-rate-info").text(`* åŒ¯ç‡åƒè€ƒï¼š1 TWD â‰ˆ ${exchangeRate} KRW`);
            let scheduleData={};
            $.ajax({
                url: "./car.json",
                cache: false,  // é—œéµè¨­å®šï¼šå¼·åˆ¶ä¸å¿«å–
                dataType: "json",
                success: function(data) {
                    scheduleData=data;
                    renderDayNav(); // å…ˆå»ºç«‹æŒ‰éˆ•
                    setDay(1);
                }
            });
            function getPayClass(pay) {
                if (!pay) return 'hidden';
                if (pay.includes('WOWPASS')) return 'pay-WOWPASS';
                if (pay.includes('TMONEY')) return 'pay-tmoney';
                if (pay.includes('åˆ·å¡')) return 'pay-card';
                return 'pay-cash';
            }

            function renderDayNav() {
                const $nav = $('#day-nav');
                $nav.empty();
                for (let day = 1; day <= 5; day++) {
                    const isActive = (currentDay === day);
                    const $btn = $('<button></button>')
                        .addClass(`nav-btn flex flex-col items-center justify-center`)
                        .addClass(isActive 
                            ? 'bg-orange-500 text-white shadow-lg scale-105 z-10 border-2 border-white' 
                            : 'bg-white/95 text-slate-600 border border-slate-200/60')
                        .append(`<span class="text-[9px] font-black leading-none mb-0.5">DAY</span>`)
                        .append(`<span class="leading-none text-xl">${day}</span>`)
                        .on('click', () => setDay(day));
                    $nav.append($btn);
                }
            }

            function setDay(day) {
                currentDay = day;
                currentPlan = 'A';
                updatePlanSwitcherUI();
                renderSchedule();
                renderDayNav();
                $('html, body').animate({ scrollTop: 0 }, 'fast');
            }

            function updatePlanSwitcherUI() {
                const dayData = scheduleData[currentDay];
                const hasPlans = dayData && !Array.isArray(dayData);
                if (hasPlans) {
                    $('#plan-switcher').removeClass('hidden');
                    $('.plan-btn').removeClass('bg-slate-800 text-white shadow-md text-slate-500 bg-transparent');
                    if (currentPlan === 'A') {
                        $('#btn-plan-A').addClass('bg-slate-800 text-white shadow-md');
                        $('#btn-plan-B').addClass('text-slate-500 bg-transparent');
                    } else {
                        $('#btn-plan-B').addClass('bg-slate-800 text-white shadow-md');
                        $('#btn-plan-A').addClass('text-slate-500 bg-transparent');
                    }
                } else {
                    $('#plan-switcher').addClass('hidden');
                }
            }

            function renderSchedule() {
                const $container = $('#schedule-container');
                let rawData = scheduleData[currentDay] || [];
                const items = Array.isArray(rawData) ? rawData : (rawData[currentPlan] || []);
                
                $container.empty();
                let totalKRW = 0, totalTWD = 0;
                let paySummary = {};

                if (items.length === 0) {
                    $('#timeline-line').hide();
                    $container.append(`<div class="text-center py-16 bg-white/10 rounded-2xl border border-dashed border-white/20 text-white font-bold text-lg italic animate-fade">DAY ${currentDay} å°šæœªè¦åŠƒè¡Œç¨‹</div>`);
                    updateSummary(0, 0, {});
                    return;
                } else {
                    $('#timeline-line').show();
                }

                $.each(items, function(index, item) {
                    const krw = item.costKRW || 0;
                    // å¦‚æœ KRW å¤§æ–¼ 0ï¼Œå‰‡è¨ˆç®— TWDï¼Œå¦å‰‡ç‚º 0
                    const twd = krw > 0 ? Math.ceil(krw / exchangeRate) : 0;
                    totalKRW += krw; totalTWD += twd;

                    if (item.pay && krw > 0) {
                        if (!paySummary[item.pay]) paySummary[item.pay] = { krw: 0 };
                        paySummary[item.pay].krw += krw;
                    }

                    // 1. æ¸²æŸ“è¡Œç¨‹å¡ç‰‡
                    const $card = $('<div></div>')
                        .addClass("glass-card p-5 animate-fade mb-4 ml-14")
                        .css('animation-delay', `${index * 0.1}s`)
                        .html(`
                            <!-- æ™‚é–“é»ç¯€é» -->
                            <div class="absolute -left-[41px] top-6 w-7 h-7 bg-orange-500 border-4 border-white rounded-full shadow-md z-20"></div>
                            
                            <div class="flex justify-between items-center mb-3">
                                <div class="flex items-center gap-2">
                                    <span class="time-span text-lg font-black text-orange-600 bg-orange-50 px-2 py-0.5 rounded-lg border border-orange-100">${item.time}</span>
                                    <span class="kind-span px-2 py-0.5 rounded text-[12px] font-black bg-slate-100 text-slate-500 border border-slate-200">${item.category}</span>
                                </div>
                                <span class="pay-tag ${getPayClass(item.pay)}">${item.pay || ''}</span>
                            </div>
                            
                            <h3 class="text-xl font-black text-slate-900 mb-3">${item.location}</h3>
                            
                            <div class="flex justify-between items-end gap-2">
                              <div class="space-y-2 flex-grow">
                                    ${item.link ? `
                                        <button
                                            onclick='handleLinkClick(${JSON.stringify(item.link)})'
                                            class="inline-flex items-center gap-1.5 bg-blue-600 text-white px-3.5 py-1.5 rounded-lg text-sm font-black shadow-sm active:scale-95 transition-transform">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" class="w-4 h-4">
                                                <circle cx="12" cy="12" r="10"/>
                                                <line x1="12" y1="16" x2="12" y2="12"/>
                                                <line x1="12" y1="8" x2="12.01" y2="8"/>
                                            </svg>
                                            æŸ¥çœ‹ä»‹ç´¹
                                        </button>
                                    ` : ''}
                                </div>

                                ${krw > 0 ? `
                                <div class="text-right flex-shrink-0">
                                    <p class="text-xl font-black text-slate-900 tabular-nums leading-none mb-1">â‚©${krw.toLocaleString()}</p>
                                    <p class="text-[15px] font-bold text-blue-600 tabular-nums leading-none">NT$ ${twd.toLocaleString()}</p>
                                </div>` : ''}
                            </div>
                        `);
                    $container.append($card);

                    // 2. æ¸²æŸ“éŠœæ¥äº¤é€š (å¦‚æœä¸æ˜¯æœ€å¾Œä¸€é …)
                    if (index < items.length - 1) {
                        const nextItem = items[index + 1];
                        // çµ„åˆè·é›¢èˆ‡æ™‚é–“æ–‡å­—
                        const infoText = [nextItem.distance, nextItem.duration].filter(Boolean).join(' Â· ');
                        var full_transport = get_icon(nextItem.transport) + ' ' + nextItem.transport;
                        const $transport = $('<div></div>')
                            .addClass("transport-connector animate-fade py-2 mb-4")
                            .css('animation-delay', `${index * 0.1 + 0.05}s`)
                            .html(`
                                <div class="flex items-center gap-2 text-slate-300">
                                    <div class="trans-span  bg-white/20 px-3 py-1 rounded-full border border-white/10 flex items-center gap-2">
                                        <span class="text-sm font-black text-white">${full_transport}</span>
                                        ${infoText ? `<span class="text-[11px] font-bold opacity-70">(${infoText})</span>` : ''}
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" class="w-3 h-3 text-orange-400"><path d="M7 13l5 5 5-5M7 6l5 5 5-5"/></svg>
                                    </div>
                                </div>
                            `);
                        $container.append($transport);
                    }
                });

                updateSummary(totalKRW, totalTWD, paySummary);
				$('.time-span').each(function() {
					// ä½¿ç”¨ $.trim ç§»é™¤ç©ºæ ¼ï¼Œåˆ¤æ–·å…§å®¹æ˜¯å¦é•·åº¦ç‚º 0
					if ($.trim($(this).text()) === "") {
						$(this).hide();
					}
				});
				$('.kind-span').each(function() {
					// ä½¿ç”¨ $.trim ç§»é™¤ç©ºæ ¼ï¼Œåˆ¤æ–·å…§å®¹æ˜¯å¦é•·åº¦ç‚º 0
					if ($.trim($(this).text()) === "") {
						$(this).hide();
					}
				});
				$('.trans-span ').each(function() {
					// ä½¿ç”¨ $.trim ç§»é™¤ç©ºæ ¼ï¼Œåˆ¤æ–·å…§å®¹æ˜¯å¦é•·åº¦ç‚º 0
					if ($.trim($(this).text()) === "") {
						$(this).hide();
					}
				});
				
            }
            function get_icon(transport) {
                switch (transport) {
                    case 'æ­¥è¡Œ': return 'ğŸš¶';
                    case 'å…¬è»Š': return 'ğŸšŒ';
                    case 'æ¥é§è»Š': return 'ğŸšŒ';
                    case 'è¨ˆç¨‹è»Š': return 'ğŸš–';
                    case 'é–‹è»Š': return 'ğŸš—';
                    default: return '';
                }
            }
            function updateSummary(krw, twd, summary) {
                $('#total-krw').text(`â‚© ${krw.toLocaleString()}`);
                $('#total-twd').text(`NT$ ${twd.toLocaleString()}`);
                $('#current-day-label').text(`Day ${currentDay}${(!Array.isArray(scheduleData[currentDay])) ? ` - æ–¹æ¡ˆ ${currentPlan}` : ''}`);
                
                const $subtotalBox = $('#payment-subtotal');
                $subtotalBox.empty();
                
                $.each(summary, function(method, costs) {
                    const $div = $('<div></div>')
                        .addClass("flex justify-between items-center bg-white/5 p-2.5 rounded-lg border border-white/10")
                        .html(`
                            <span class="pay-tag ${getPayClass(method)}">${method}</span>
                            <span class="text-white text-base font-black tabular-nums">â‚© ${costs.krw.toLocaleString()}</span>
                        `);
                    $subtotalBox.append($div);
                });
            }

            $('#btn-plan-A').on('click', function() {
                if (currentPlan === 'A') return;
                currentPlan = 'A';
                updatePlanSwitcherUI();
                renderSchedule();
            });

            $('#btn-plan-B').on('click', function() {
                if (currentPlan === 'B') return;
                currentPlan = 'B';
                updatePlanSwitcherUI();
                renderSchedule();
            });

            
        });
        function openLinksModal(links) {
            const modal = document.getElementById('linksModal');
            const content = document.getElementById('linksModalContent');

            content.innerHTML = links.map((link, i) => `
                <a href="${link}" target="_blank"
                class="block w-full text-center bg-blue-600 text-white py-2 rounded-lg font-bold">
                    é€£çµ ${i + 1}
                </a>
            `).join('');

            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function closeLinksModal() {
            const modal = document.getElementById('linksModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }
        function handleLinkClick(link) {
            // ä¸æ˜¯é™£åˆ—ï¼Œç›´æ¥é–‹
            if (!Array.isArray(link)) {
                window.open(link, '_blank');
                return;
            }

            // é™£åˆ—ä½†åªæœ‰ä¸€å€‹ï¼Œç›´æ¥é–‹
            if (link.length === 1) {
                window.open(link[0], '_blank');
                return;
            }

            // é™£åˆ—ä¸”å¤šå€‹ï¼Œé–‹ modal
            openLinksModal(link);
        }
    </script>
</body>
</html>
